---
import Layout from "../layouts/Layout.astro";
import { getCldImageUrl } from "astro-cloudinary/helpers";
import { getAssetInfo } from "../utils/get-description";
import { getStory } from "../utils/get-prompt";
import { getRandomName } from "src/utils/get-random-name";
import { getPromptsToGenerate } from "src/utils/get-prompts-to-generate";

const { searchParams } = Astro.url;
const id = searchParams.get("id");
let description = searchParams.get("description");
let name = searchParams.get("name");
if (id === null) return Astro.redirect("/404?reason=ID");

if (description === null) {
  description = await getAssetInfo(id);
  if (description === null) return Astro.redirect("/404?reason=Description");
}

if (name === null) name = getRandomName();
const story = getStory(name);
const { title, paragraphs  } = story;

const url = getCldImageUrl({
  src: id,
});

const images = getPromptsToGenerate(story, id);

console.log({ id, description, url, images });
---

<Layout title="Welcome to Astro">
  <section class="mx-auto max-w-[1200px]">
    <div class="mx-auto max-w-[700px]">
      <img
        class="max-w-full md:max-w-4/5 "
        src={url}
        alt={`${"url"}-image`}
      />
    </div>
    <!-- <p>{description}</p> -->
    <p class="mx-auto max-w-[800px] text-center my-5">
      The image shows a close-up of a fluffy gray and white cat with a stern
      expression, accompanied by text in Spanish that reads "You're an imbecile.
    </p>
    <br />
    <article>
      <h2 class="text-xl md:text-2xl">
        {title}
      </h2>
      {
        paragraphs.map((paragraph) => {
          return (
            <p class="prose dark:prose-invert">
              {paragraph.text}
            </p>
            <div class="flex justify-center">
              {paragraph.index_image !== null && 
              <img
                class="max-w-full md:max-w-4/5 "
                src={images[paragraph.index_image]} 
                alt={`${paragraph.index_image}-image`} 
              />
              }
            </div>
          )
        })
      }
    </article>
  </section>
</Layout>

<style>
  section {
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: light-dark(#fff, #1b1b1b);
    border: 4px solid light-dark(#28374773, #d4dbdb49);
    border-radius: 15px;
    padding: 1rem;
  }
  h2 {
    text-align: center;
  }
  p {
    color: light-dark(#313131, #a7a5a5);
    text-align: center;
    font-size: 1.2rem;
  }
  article p {
    font-size: 1.2rem;
    margin: 15px auto;
  }

  img {
    height: auto;
    border-radius: 15px;
  }
  article {
    margin: auto;
    gap: 20px;
    max-width: 1000px;
  }
</style>
